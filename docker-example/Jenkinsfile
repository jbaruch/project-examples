pipeline {
    agent any
    stages {
        stage('Setup') {
            steps {
                script {
                    git url: 'https://github.com/jbaruch/docker-examples'
                    server = Artifactory.server ARTIFACTORY
                    buildInfo = Artifactory.newBuildInfo()
                    rtDocker = Artifactory.docker credentialsId: ARTIFACTORY_CREDENTIALS
                    buildInfo.env.capture = true
                }
            }
        }
        stage('Download dependencies') {
          steps {
              script {
                dir ('docker-examples') {
                  downloadAppSpec = readFile 'appmodules-download.json'
                  rtServer.download downloadAppSpec, buildInfo
              }
            }
          }
        }
        stage('Build') {
            steps {
                script {
                  dir ('docker-examples') {
                      tagDockerApp = "${server.url.toURL().host}:${DOCKER_PORT}/docker-example:${env.BUILD_NUMBER}"
                      docker.build tagDockerApp
                      }
                    }
                  }
                }
              }
        stage('Deploy') {
            steps {
                script {
                  rtDocker.push(tagDockerApp, 'docker', buildInfo)
                  buildInfo.env.collect()
                  rtServer.publishBuildInfo buildInfo
                }
            }
        }
    }
}
